{% extends "base.html" %}
{% block content %}

<head>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chatroom.css') }}">
</head>

<!-- <body> -->
<div class="container py-5 px-4">
    <!-- For demo purpose-->
    <!-- <header class="text-center">
        <h1 class="display-4 text-white">Bootstrap Chat</h1>
        <p class="text-white lead mb-0">An elegant chat widget compatible with Bootstrap 4</p>
        <p class="text-white lead mb-4">Snippet by
            <a href="https://bootstrapious.com" class="text-white">
                <u>Bootstrapious</u></a>
        </p>
    </header> -->
    <h3>{{ current_user.username }}</h3>
    <div class="row rounded-lg overflow-hidden shadow">
        <!-- Users box-->
        <div class="col-5 px-0">
            <div class="bg-white">

                <div class="bg-gray px-4 py-2 bg-light">
                    <p class="h5 mb-0 py-1">Recent</p>
                </div>

                <div class="messages-box">
                    <div class="list-group rounded-0">
                        <!-- <a class="list-group-item list-group-item-action active text-white rounded-0">
                            <div class="media"><img
                                    src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg"
                                    alt="user" width="50" class="rounded-circle">
                                <div class="media-body ml-4">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h6 class="mb-0">Jason Doe</h6><small class="small font-weight-bold">25
                                            Dec</small>
                                    </div>
                                    <p class="font-italic mb-0 text-small">Lorem ipsum dolor sit amet, consectetur
                                        adipisicing elit, sed do eiusmod tempor incididunt ut labore.</p>
                                </div>
                            </div>
                        </a> -->
                        {% for room in rooms %}
                        {% if room.id == room_id %}
                        <a class="list-group-item list-group-item-action active text-white rounded-0">
                            {% else %}
                            <a href="/room/{{ room.id }}"
                                class="list-group-item list-group-item-action list-group-item-light rounded-0">
                                {% endif %}
                                <div class="media">
                                    <div class="media-body ml-2">
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <h6 class="mb-0">{{room.id}} {{ room.name }}</h6><small
                                                class="small font-weight-bold">14
                                                Dec</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}

                    </div>
                </div>
            </div>
        </div>
        <!-- Chat Box-->
        <div class="col-7 px-0">
            <div id="chat-box" class="px-4 py-5 chat-box bg-white">

                {% for message in messages %}
                {% if current_user.id == message.user_id %}
                <!-- Reciever Message-->
                <div class="media w-50 ml-auto mb-3">
                    <div class="media-body">
                        <div class="bg-primary rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-white">{{ message.message }}</p>
                        </div>
                        <p class="small text-muted">{{ message.datetime.strftime('%I:%M %p | %b %d') }}</p>
                    </div>
                </div>
                {% else %}
                <!-- Sender Message-->
                <div class="media w-50 mb-3"><img
                        src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" alt="user"
                        width="50" class="rounded-circle">
                    <div class="media-body ml-3">
                        <div class="bg-light rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-muted">{{ message.message }}</p>
                        </div>
                        <p class="small text-muted">{{ message.datetime.strftime('%I:%M %p | %b %d') }}</p>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Typing area -->
            <form id="message-form" action="" class="bg-light" action="POST">
                <div class="input-group">
                    <input id="message-input-box" type="text" placeholder="Type a message"
                        aria-describedby="button-addon2" class="form-control rounded-0 border-0 py-4 bg-light">
                    <div class="input-group-append">
                        <button id="button-addon2" type="submit" class="btn btn-link"> <i
                                class="fa fa-paper-plane"></i></button>
                    </div>
                </div>
            </form>
            <!-- <form id="message-form" action="" method="POST">
                <input type="text" id="message-input-box" placeholder="Messages" />
                <input type="submit" />
            </form> -->

        </div>
    </div>
</div>
{% endblock content %}
{% block footer %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<!-- <script src="{{ url_for('static', filename='script.js') }}"></script> -->
<script type="text/javascript">
$(document).ready(function () {
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var current_room_id = '{{ room_id }}';
    let current_user_id = '{{ current_user.id }}';


    var myDiv = document.getElementById("chat-box");
    myDiv.scrollTop = myDiv.scrollHeight;

    socket.on('connect', function () {
        console.log('connected:')
        socket.emit('my event', {
            data: 'User Connected'
        })
    })

    var form = $('#message-form').on('submit', function (e) {
        e.preventDefault()
        if (current_room_id){
            let user_input = $('#message-input-box').val()
            socket.emit('send', {
                user_name: '{{ current_user.username }}',
                user_id: current_user_id,
                room_id: current_room_id,
                message: user_input
            })
        }
        $('#message-input-box').val('').focus()
    })

    $('#join').click(function () {
        let room = $('#room').val()
        socket.emit('join', room)
        $('h2#roomname').text(room)
        $('#room').val('')
    })

    $('#create').click(function () {
        let room = $('#room').val()
        socket.emit('create', room)
        // $('h2#roomname').text(room)
        $('#room').val('')
    })

    $("#leave").click(function () {
        socket.emit('leave')
        // $('h2#roomname').text('')
    })

    socket.on('room info', function (rooms) {
        // $('div.message_holder').append('<div><b style="color: #000">' + msg + '</b></div>')
        console.log(rooms)
    })

    socket.on('message', function (msg) {
        console.log("{{ url_for('home') }}" + '/room')
        console.log(current_room_id, msg.room_id)
        if (current_room_id == msg.room_id) {
            if (current_user_id == msg.user_id)
                append_receiver_chat_box(msg.message, msg.datetime);
            else
                append_sender_chat_box(msg.message, msg.datetime);
        }
    })

    function append_sender_chat_box(message, datetime){
        $('div.chat-box').append(
            `
            <div class="media w-50 mb-3"><img
                    src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" alt="user"
                    width="50" class="rounded-circle">
                <div class="media-body ml-3">
                    <div class="bg-light rounded py-2 px-3 mb-2">
                        <p class="text-small mb-0 text-muted">` + message + `</p>
                    </div>
                    <p class="small text-muted">` + datetime + `</p>
                </div>
            </div>
            `
        );
    }

    function append_receiver_chat_box(message, datetime){
        $('div.chat-box').append(
            `
            <div class="media w-50 ml-auto mb-3">
                <div class="media-body">
                    <div class="bg-primary rounded py-2 px-3 mb-2">
                        <p class="text-small mb-0 text-white">` + message + `</p>
                    </div>
                    <p class="small text-muted">` + datetime + `</p>
                </div>
            </div>
            `
        );
    }
})
</script>
{% endblock %}