{% extends "base.html" %}
{% block content %}
<head>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chatroom.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='create_room.css') }}">
</head>
<!-- <body> -->
<div class="container py-5 px-4">
    <!-- For demo purpose-->
    <!-- <header class="text-center">
        <h1 class="display-4 text-white">Bootstrap Chat</h1>
        <p class="text-white lead mb-0">An elegant chat widget compatible with Bootstrap 4</p>
        <p class="text-white lead mb-4">Snippet by
            <a href="https://bootstrapious.com" class="text-white">
                <u>Bootstrapious</u></a>
        </p>
    </header> -->
    <h3>{{ current_user.username }}</h3>
    <div class="row rounded-lg overflow-hidden shadow">
        <!-- Users box-->
        <div class="col-5 px-0 bg-white">
            <div class="bg-gray px-4 py-2 bg-light">
                <div class="row">
                    <!-- <p class="h5 mb-0 py-1">Recent</p> -->
                    <p class="h5 mb-0 py-1 col">Chatroom</p>

                    <!-- Button trigger modal -->
                    <div class="col text-right">
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#create-modal">
                            Create
                        </button>
                        {% if current_room %}
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#invite-modal">
                            Invite
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#confirm-delete">
                            Delete
                        </button>
                    </div>

                    <!-- Invite Modal -->
                    {% if current_room %}
                    <div class="modal fade" id="invite-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header d-block">
                                    <div class="d-flex">
                                        <h5 class="modal-title" >Add people</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <small class="modal-title">{{ current_room.name }}</small>
                                </div>
                                <div class="modal-body">
                                    <div class="dropdown input-holder d-flex flex-wrap">
                                        <input class="dropdown-toggle flex-grow-1 modal-input" id="find-user-input" type="text" data-toggle="dropdown">
                                        <div id="username-drop-down" class="dropdown-menu scrollable-menu">
                                            <!-- {% for user in users %}
                                            {% if not user.is_room_member %}
                                            <a class="dropdown-item" href="#">{{ user.username }}</a>
                                            {% endif %}
                                            {% endfor %} -->

                                        </div>
                                      </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="invite" data-dismiss="modal">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Create Modal -->
                    <div class="modal fade" id="create-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header d-block">
                                    <div class="d-flex">
                                        <h5 class="modal-title">Create room</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="modal-body d-flex">
                                    <input class="flex-grow-1 modal-input" id="create-room-input" type="text" data-toggle="dropdown">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="create">Create</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Confirmation Modal -->
                    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Delete Room?</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <span>Are you sure you want to delete <span class="current-room font-weight-bold">{{ current_room.name }}</span></span>
                                </div>
                                <div class="modal-footer">
                                    <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button> -->
                                    <a class="btn btn-danger btn-ok text-white">Delete</a>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <div class="messages-box">
                <div id="room-list" class="list-group rounded-0">
                    <!-- <a class="list-group-item list-group-item-action active text-white rounded-0">
                        <div class="media"><img
                                src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg"
                                alt="user" width="50" class="rounded-circle">
                            <div class="media-body ml-4">
                                <div class="d-flex align-items-center justify-content-between mb-1">
                                    <h6 class="mb-0">Jason Doe</h6><small class="small font-weight-bold">25
                                        Dec</small>
                                </div>
                                <p class="font-italic mb-0 text-small">Lorem ipsum dolor sit amet, consectetur
                                    adipisicing elit, sed do eiusmod tempor incididunt ut labore.</p>
                            </div>
                        </div>
                    </a> -->
                    <!-- {% for room in rooms %}
                    {% if current_room and room.id == current_room.id %}
                    <a class="list-group-item list-group-item-action active text-white rounded-0">
                    {% else %}
                    <a href="/room/{{ room.id }}" class="list-group-item list-group-item-action list-group-item-light rounded-0">
                    {% endif %}
                        <div class="media">
                            <div class="media-body ml-2">
                                <div class="d-flex align-items-center justify-content-between mb-1">
                                    <h6 class="mb-0">{{ room.name }}</h6> -->
                                    <!-- <small class="small font-weight-bold">14 Dec</small> -->
                                    <!-- <span class="badge badge-pill badge-info">4</span> -->
                                    <!-- <small id="room{{ room.id }}-notification" class="invisible"><span class="badge badge-secondary">0</span></small> -->
                                <!-- </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %} -->

                </div>
            </div>
        </div>

        <!-- Chat Box-->
        <div class="col-7 px-0">
            <div id="chat-box" class="px-4 py-5 chat-box bg-white">
                <!-- {% for message in messages %}
                {% if current_user.id == message.user_id %}
                Reciever Message
                <div class="media w-50 ml-auto mb-3">
                    <div class="media-body">
                        <div class="bg-primary rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-white">{{ message.message }}</p>
                        </div>
                        <p class="small text-muted">{{ message.datetime.strftime('%I:%M %p | %b %d') }}</p>
                    </div>
                </div>
                {% else %}
                Sender Message
                <div class="media w-50 mb-3"><img
                        src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" alt="user"
                        width="50" class="rounded-circle">
                    <div class="media-body ml-3">
                        <div class="bg-light rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-muted text-wrap">{{ message.message }}</p>
                        </div>
                        <p class="small text-muted">{{ message.datetime.strftime('%I:%M %p | %b %d') }}</p>
                    </div>
                </div>
                {% endif %}
                {% endfor %} -->
            </div>

            <!-- Typing area -->
            <form id="message-form" action="" class="bg-light" action="POST" autocomplete="off">
                <div class="input-group">
                    <input id="message-input-box" type="text" placeholder="Type a message"
                        aria-describedby="button-addon2" class="form-control rounded-0 border-0 py-4 bg-light shadow-none">
                    <div class="input-group-append">
                        <button id="button-addon2" type="submit" class="btn btn-link"> <i
                                class="fa fa-paper-plane"></i></button>
                    </div>
                </div>
            </form>
            <!-- <form id="message-form" action="" method="POST">
                <input type="text" id="message-input-box" placeholder="Messages" />
                <input type="submit" />
            </form> -->

        </div>
    </div>
</div>
<script type="text/javascript">
var chat_box = document.getElementById('chat-box');
chat_box.scrollTop = chat_box.scrollHeight;
</script>
{% endblock content %}
{% block footer %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<!-- <script src="{{ url_for('static', filename='script.js') }}"></script> -->
<script type="text/javascript">
$(document).ready(function () {
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var current_room_id = '{{ current_room.id }}';
    var current_room_name = '{{ current_room.name }}';
    let current_user_id = '{{ current_user.id }}';

    $("#find-user-input").on("keyup", function() {
        var value = $(this).val().toLowerCase();

        $(".dropdown-menu a").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    $('.dropdown-menu').find('a').click(function(e) {
        e.preventDefault();
        var param = $(this).html();
        $('#find-user-input').before('<span class="badge badge-secondary align-self-center mr-1">' + param + '</span>');
        $('input').val('');
        $('#find-user-input').load("#find-user-input");
    });

    $("#find-user-input").keydown(function(e){
        if(e.which==8 && $(this).val() == '')
          $(this).prev().remove();
    });

    $('.modal').on('shown.bs.modal', function() {
        $(this).find('input').focus();

        if ($(this).attr('id') == 'invite-modal'){
            $('#username-drop-down').empty();
            get_not_in_room_users(current_room_id).then(users => {
            console.log(users);
            jQuery.each(users, function() {
                $('#username-drop-down').append('<a class="dropdown-item" href="#">' + this.username + '</a>')
            });
        });
        }
    })

    const get_room_list = async () => {
        const response = await fetch('http://' + document.domain + ':' + location.port + '/room_list');
        const room_list = await response.json();
        return room_list;
    }

    const get_messages = async (room_id) => {
        const response = await fetch('http://' + document.domain + ':' + location.port + '/room/' + room_id + '/messages');
        const messages = await response.json();
        return messages;
    }

    const get_users = async () => {
        const response = await fetch('http://' + document.domain + ':' + location.port + '/users');
        const users = await response.json();
        return users;
    }

    const get_not_in_room_users = async (room_id) => {
        const response = await fetch('http://' + document.domain + ':' + location.port + '/room/' + room_id + '/' + 'not_members');
        const users = await response.json();
        return users;
    }

    function initialize_room_list() {
        get_room_list().then(rooms => {
            jQuery.each(rooms, function() {
                append_room_list(this.id, this.name, current_room_id == this.id);
            });
        });
    }

    initialize_room_list();

    $('div#room-list').on('click', 'a.room', function(e) {
        e.preventDefault();
        current_room_id = parseInt($(this).attr('href'));
        current_room_name = $(this).attr('data-room-name');

        $('#room-list a.active').addClass('list-group-item-light').removeClass('active');
        $(this).addClass('active').removeClass('list-group-item-light');
        $('div.chat-box').empty();

        $('.current-room').text(current_room_name);

        get_messages(current_room_id).then(messages => {
            jQuery.each(messages, function() {
                if (this.user_id == current_user_id)
                append_receiver_chat_box(this.message, this.datetime);
                else
                append_sender_chat_box(this.message, this.datetime);
            });
        });

        history.pushState('data to be passed', '', '/room/'+ current_room_id);
    });

    // get_room_list();

    // const userAction = async () => {
    //     const response = await fetch('http://' + document.domain + ':' + location.port + '/create_room', {
    //         method: 'POST',
    //         body: JSON.stringify({room_name : 'room113'}), // string or object
    //         headers: {
    //             'Content-Type': 'application/json'
    //         }
    //     });
    //     const myJson = await response.text(); //extract JSON from the http response
    //     console.log(myJson);
    //     // do something with myJson
    // }

    // userAction();

    socket.on('connect', function () {
        console.log('connected:')
        socket.emit('my event', {
            data: 'User Connected'
        })
    })

    var form = $('#message-form').on('submit', function (e) {
        e.preventDefault()
        if (current_room_id){
            let user_input = $('#message-input-box').val()
            if (user_input){
                socket.emit('send', {
                    user_name: '{{ current_user.username }}',
                    user_id: current_user_id,
                    room_id: current_room_id,
                    message: user_input
                })
            }
        }
        $('#message-input-box').val('').focus()
    })

    $("#invite").click(function () {
        var users = [];
        $(".input-holder span").each(function() { users.push($(this).text()) });
        socket.emit('invite', {
            room_id: current_room_id,
            users : users
        })
        $('#invite-modal').modal('hide');
    })

    $('#create').click(function () {
        let room_name = $('#create-room-input').val();
        socket.emit('create', room_name);
        $('#create-modal').modal('hide');
        socket.on('redirect room', function(room_id) {
            // $('div.message_holder').append('<div><b style="color: #000">' + msg + '</b></div>')
            window.location.replace('http://' + document.domain + ':' + location.port + '/room/' + room_id);
        })
    })

    $('#confirm-delete').on('show.bs.modal', function(e) {
        $(this).find('.btn-ok').click(function(){
            console.log(current_room_id);
            socket.emit('delete', {
                room_id: current_room_id,
            })
            $('#confirm-delete').modal('hide');
            $('#room-list a.active').remove()
        });

    });

    $('#join').click(function () {
        let room = $('#room').val()
        socket.emit('join', room)
        $('h2#roomname').text(room)
        $('#room').val('')
    })

    $("#leave").click(function () {
        socket.emit('leave')
        // $('h2#roomname').text('')
    })

    socket.on('room info', function (rooms) {
        // $('div.message_holder').append('<div><b style="color: #000">' + msg + '</b></div>')
        console.log(rooms)
    })

    socket.on('message', function (msg) {
        console.log("{{ url_for('home') }}" + '/room')
        console.log(current_room_id, msg.room_id)
        if (current_room_id == msg.room_id) {
            if (current_user_id == msg.user_id)
                append_receiver_chat_box(msg.message, msg.datetime);
            else
                append_sender_chat_box(msg.message, msg.datetime);
            scroll_bottom('chat-box');
        }
    })

    function append_sender_chat_box(message, datetime){
        $('div.chat-box').append(
            `
            <div class="media w-50 mb-3"><img
                    src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" alt="user"
                    width="50" class="rounded-circle">
                <div class="media-body ml-3">
                    <div class="bg-light rounded py-2 px-3 mb-2">
                        <p class="text-small mb-0 text-muted">` + message + `</p>
                    </div>
                    <p class="small text-muted">` + datetime + `</p>
                </div>
            </div>
            `
        );
    }

    function append_receiver_chat_box(message, datetime){
        $('div.chat-box').append(
            `
            <div class="media w-50 ml-auto mb-3">
                <div class="media-body">
                    <div class="bg-primary rounded py-2 px-3 mb-2">
                        <p class="text-small mb-0 text-white">` + message + `</p>
                    </div>
                    <p class="small text-muted">` + datetime + `</p>
                </div>
            </div>
            `
        );
    }

    function append_room_list(id, name, activate){
        if (activate){
            $('div#room-list').append(
                `
                <a href="` + id + `" class="room active list-group-item list-group-item-action rounded-0">
                    <div class="media">
                        <div class="media-body ml-2">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h6 class="mb-0">` + name + `</h6>
                            </div>
                        </div>
                    </div>
                </a>
                `
            );
        }
        else{
            $('div#room-list').append(
                `
                <a href="` + id + `" class="room list-group-item list-group-item-action list-group-item-light rounded-0" data-room-id="` + id + `" data-room-name="` + name + `">
                    <div class="media">
                        <div class="media-body ml-2">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h6 class="mb-0">` + name + `</h6>
                            </div>
                        </div>
                    </div>
                </a>
                `
            );
        }
    }

    function scroll_bottom(id){
        var chat_box = document.getElementById(id);
        chat_box.scrollTop = chat_box.scrollHeight;
    }
})
</script>
{% endblock %}